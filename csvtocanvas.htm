<!DOCTYPE html>
<html>
<body>

<header><button id="scanBtn" class="btn-scan">Scan</button></header>
<canvas id="myCanvas" width="720" height="120" style="border:1px solid #d3d3d3;"></canvas>
<main style="display: none;"><a style="cursor: pointer" id="output"  style="white-space: pre;" download='pulse.csv'></a></main>

<input type="file" />

<script>
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
ctx.fillText(canvas.height, 700, 8)  //

var X0, xavg=xind=0  //

function manu(item){
 const line = item.split(';')
 const y=line[location.search.slice(1)]||line[1]  //?4 row
 if(!X0) {X0=line[0];ctx.fillText(new Date(X0*1000).toJSON().slice(11,16), 0, canvas.height)};
 if(y!=255) ctx.lineTo((line[0]-X0)/60,canvas.height-1*y);
 xavg+=1*y; xind++
}

var mutationObserver = new MutationObserver(function() {
 const tmp=output.textContent.match(/.*\n$/)[0]; if(tmp.match(/\d+;/)) {manu(tmp);ctx.stroke();console.log(xavg/xind)}
});

mutationObserver.observe(output, {childList: true});

if(location.search.slice(1)>=1) {var event=new Event('contextmenu');window.setInterval(function(){document.querySelector('#scanBtn').dispatchEvent(event)}, location.search.slice(1)*60000)}  //?1 hr every 1 min
output.onclick=function(){output.href='data:,'+encodeURI(this.innerHTML.match(/Finished\.\n([^]*)/)[1])}  //download

document.querySelector('input').onchange = function() {var reader=new FileReader();reader.onload=function(){cv(reader.result)};reader.readAsText(this.files[0])}

function cv(that) {
 const lines = that.replace(/\r?\n$/,'').split(/\r?\n/);
 lines.forEach(function(item,index){manu(item)})
 ctx.stroke();
 console.log(xavg/xind)
}

</script>
<script src="webapp.bundle.js"></script>
</body>
</html>
