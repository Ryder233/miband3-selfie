<!DOCTYPE html>
<html lang="en">
<head><meta name="viewport" content="width=device-width,initial-scale=1"><title>&hearts; Monitor</title></head>
<body style='width:initial;box-shadow:initial'>

<header><h1><a href="https://github.com/dj0001/miband3-selfie" class="h1-right" style='color:#41c5f4;transition: color 1s'>&hearts;</a></h1><button id="scanBtn" class="btn-scan">Scan</button></header>
<canvas id="myCanvas" width="720" height="120" style="border:1px solid #d3d3d3;background:repeating-linear-gradient(to top,transparent,transparent 59px,#d3d3d3 60px)"></canvas>
<main style="display: none;"><a style="cursor: pointer;white-space: pre" id="output" download='pulse.csv'></a></main>

<input type="file" id="upl"/><label for="upl">Optionally upload HR.csv</label>

<script>
var upluri=''  // './' edit here
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");

var hrs=[]  //X0

function manu(){
var X1=hrs[hrs.length-1].split(/;|\t/), xavg=0
document.querySelector('.h1-right').textContent=X1[1]  //crop in OBS
document.querySelector('.h1-right').style.color='hsl('+(180-X1[1])+',100%,50%)'  //
canvas.width=canvas.width; ctx.fillText(canvas.height, 700, 8); ctx.fillText(new Date(X1[0]*1000).toJSON().slice(11,16), 690, canvas.height)
for(var i=hrs.length-1;i>=0;i--){
 const line = hrs[i].split(/;|\t/)
 const y=line[location.search.slice(1)]||line[1]  //?4 row
 if(isNaN(y)) {canvas.title=y; continue}
 if(y!=255) ctx.lineTo(canvas.width+(1*line[0]-X1[0])/(location.search=='?hrmStart'?1:60),canvas.height-1*y)
 xavg+=1*y
}
ctx.stroke(); ctx.fillText('\u2205'+(xavg/hrs.length).toFixed(), 0, 8)
ctx.fillText(new Date((X1[0]-(location.search=='?hrmStart'?1:60)*canvas.width)*1000).toJSON().slice(11,16), 0, canvas.height)
}

function upload(y){var xhr=new XMLHttpRequest();xhr.open("POST", upluri, true);var fd=new FormData();var blob=new Blob([1*y], {type : 'text/plain'});fd.append('file', blob, "rate.txt");xhr.send(fd)}

var mutationObserver = new MutationObserver(function() {
 const tmp=output.textContent.match(/.*\n$/)[0]; if(tmp.match(/\d+;/)) {hrs.push(tmp);manu();if(upluri) upload(tmp.split(';')[1])}
});

mutationObserver.observe(output, {childList: true});

if(location.search.slice(1)>=1) {var event=new Event('contextmenu');window.setInterval(function(){document.querySelector('#scanBtn').dispatchEvent(event)}, location.search.slice(1)*60000)}  //?1 hr every 1 min
output.onclick=function(){output.href='data:,'+encodeURI(this.innerHTML.match(/Finished\.\n([^]*)/)[1])}  //download

document.querySelector('input').onchange = function() { var reader=new FileReader(); if(this.files[0].name.slice(-3)=='csv')
 {reader.onload=function(){cv(reader.result)};reader.readAsText(this.files[0])} else 
 {reader.onload=function(){db(reader.result)};reader.readAsArrayBuffer(this.files[0])} }

function cv(that) {
 const lines = that.replace(/\r?\n$/,'').split(/\r?\n/);
 hrs=lines; manu()
}

//if(sessionStorage.csv) cv(sessionStorage.csv)  //dbtocsv
function db(that) {
var scr = document.createElement("script")
scr.src='https://cdnjs.cloudflare.com/ajax/libs/sql.js/0.5.0/js/sql.js'
scr.onload=function(){
		var Uints = new Uint8Array(that);
		var db = new SQL.Database(Uints);
		var contents = db.exec("SELECT * FROM MI_BAND_ACTIVITY_SAMPLE");  //  LIMIT 0,30
		console.log(contents[0].columns)
		const csv=contents[0].values.join('\n').replace(/,/g,";")
		cv(csv)
    document.body.insertAdjacentHTML('beforeend', '<a download="miband.csv" href="data:,'+encodeURI(csv)+'">download</a>')  //(contents[0].columns+'\n').replace(/,/g,";")+
}
document.body.appendChild(scr)
}

if(location.search=='?m') window.setInterval(function(){ //document.body.style.all='initial';  //?m monitor
 fetch('rate.txt').then(function(response) {response.text().then(function(text){
  hrs.push(Date.now()/1000+';'+text);manu()  //document.body.innerHTML=text
 })})
}, 60000)
</script>
<script src="webapp.bundle.js"></script>
</body>
</html>
